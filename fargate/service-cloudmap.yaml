---
# Copyright 2019 widdix GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Fargate: service that runs on a Fargate cluster based on fargate/cluster.yaml with service discovery via Cloud Map, a cloudonaut.io template'
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
    - Label:
        default: 'Parent Stacks'
      Parameters:
      - ParentVPCStack
      - ParentClusterStack
      - ParentAlertStack
      - ParentCloudMapStack
      - ParentClientStack
      - ParentClientStack1
      - ParentClientStack2
      - ParentClientStack3
      - ParentSSHBastionStack
    - Label:
        default: 'Task Parameters'
      Parameters:
      - TaskPolicies
      - ProxyImage
      - ProxyCommand
      - ProxyPort
      - ProxyEnvironment1Key
      - ProxyEnvironment1Value
      - ProxyEnvironment2Key
      - ProxyEnvironment2Value
      - ProxyEnvironment3Key
      - ProxyEnvironment3Value
      - AppImage
      - AppCommand
      - AppPort
      - AppEnvironment1Key
      - AppEnvironment1Value
      - AppEnvironment2Key
      - AppEnvironment2Value
      - AppEnvironment3Key
      - AppEnvironment3Value
      - SidecarImage
      - SidecarCommand
      - SidecarPort
      - SidecarEnvironment1Key
      - SidecarEnvironment1Value
      - SidecarEnvironment2Key
      - SidecarEnvironment2Value
      - SidecarEnvironment3Key
      - SidecarEnvironment3Value
    - Label:
        default: 'Service Parameters'
      Parameters:
      - Name
      - Cpu
      - Memory
      - SubnetsReach
      - AutoScaling
      - DesiredCount
      - MaxCapacity
      - MinCapacity
      - LogsRetentionInDays
Parameters:
  ParentVPCStack:
    Description: 'Stack name of parent VPC stack based on vpc/vpc-*azs.yaml template.'
    Type: String
  ParentClusterStack:
    Description: 'Stack name of parent Cluster stack based on fargate/cluster.yaml template.'
    Type: String
  ParentAlertStack:
    Description: 'Optional but recommended stack name of parent alert stack based on operations/alert.yaml template.'
    Type: String
    Default: ''
  ParentCloudMapStack:
    Description: 'Stack name of parent Cloud Map stack based on vpc/cloudmap-private.yaml template.'
    Type: String
  ParentClientStack:
    Description: 'Stack name of parent client stack based on state/client-sg.yaml template.'
    Type: String
  ParentClientStack1:
    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml template to allow network access from the service to whatever uses the client security group.'
    Type: String
    Default: ''
  ParentClientStack2:
    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml template to allow network access from the service to whatever uses the client security group.'
    Type: String
    Default: ''
  ParentClientStack3:
    Description: 'Optional stack name of parent Client Security Group stack based on state/client-sg.yaml template to allow network access from the service to whatever uses the client security group.'
    Type: String
    Default: ''
  ParentSSHBastionStack:
    Description: 'Optional but recommended stack name of parent SSH bastion host/instance stack based on vpc/vpc-*-bastion.yaml template.'
    Type: String
    Default: ''
  TaskPolicies:
    Description: 'Comma-delimited list of IAM managed policy ARNs to attach to the task IAM role'
    Type: String
    Default: ''
  ProxyImage:
    Description: 'Optional Docker image to use for the proxy container. You can use images in the Docker Hub registry or specify other repositories (repository-url/image:tag).'
    Type: String
    Default: ''
  ProxyCommand:
    Description: 'Optional command used when starting the proxy container.'
    Type: String
    Default: ''
  ProxyPort:
    Description: 'The port exposed by the proxy container that receives traffic from the load balancer (ProxyPort <> AppPort <> SidecarPort; ignored if ProxyImage is not set).'
    Type: Number
    Default: 8000
    MinValue: 1
    MaxValue: 49150
  ProxyEnvironment1Key:
    Description: 'Optional environment variable 1 key for proxy container.'
    Type: String
    Default: ''
  ProxyEnvironment1Value:
    Description: 'Optional environment variable 1 value for proxy container.'
    Type: String
    Default: ''
  ProxyEnvironment2Key:
    Description: 'Optional environment variable 2 key for proxy container.'
    Type: String
    Default: ''
  ProxyEnvironment2Value:
    Description: 'Optional environment variable 2 value for proxy container.'
    Type: String
    Default: ''
  ProxyEnvironment3Key:
    Description: 'Optional environment variable 3 key for proxy container.'
    Type: String
    Default: ''
  ProxyEnvironment3Value:
    Description: 'Optional environment variable 3 value for proxy container.'
    Type: String
    Default: ''
  AppImage:
    Description: 'The Docker image to use for the app container. You can use images in the Docker Hub registry or specify other repositories (repository-url/image:tag).'
    Type: String
    Default: 'widdix/hello:v1'
  AppCommand:
    Description: 'Optional commands (comma-delimited) used when starting the app container.'
    Type: String
    Default: ''
  AppPort:
    Description: 'The port exposed by the app container that receives traffic from the load balancer or the proxy container (AppPort <> ProxyPort <> SidecarPort).'
    Type: Number
    Default: 80
    MinValue: 1
    MaxValue: 49150
  AppEnvironment1Key:
    Description: 'Optional environment variable 1 key for app container.'
    Type: String
    Default: ''
  AppEnvironment1Value:
    Description: 'Optional environment variable 1 value for app container.'
    Type: String
    Default: ''
  AppEnvironment2Key:
    Description: 'Optional environment variable 2 key for app container.'
    Type: String
    Default: ''
  AppEnvironment2Value:
    Description: 'Optional environment variable 2 value for app container.'
    Type: String
    Default: ''
  AppEnvironment3Key:
    Description: 'Optional environment variable 3 key for app container.'
    Type: String
    Default: ''
  AppEnvironment3Value:
    Description: 'Optional environment variable 3 value for app container.'
    Type: String
    Default: ''
  SidecarImage:
    Description: 'Optional Docker image to use for the sidecar container. You can use images in the Docker Hub registry or specify other repositories (repository-url/image:tag).'
    Type: String
    Default: ''
  SidecarCommand:
    Description: 'Optional command used when starting the sidecar container.'
    Type: String
    Default: ''
  SidecarPort:
    Description: 'The port exposed by the sidecar container reachable from the app container on host localhost (SidecarPort <> ProxyPort <> AppPort).'
    Type: Number
    Default: 9000
    MinValue: 1
    MaxValue: 49150
  SidecarEnvironment1Key:
    Description: 'Optional environment variable 1 key for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment1Value:
    Description: 'Optional environment variable 1 value for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment2Key:
    Description: 'Optional environment variable 2 key for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment2Value:
    Description: 'Optional environment variable 2 value for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment3Key:
    Description: 'Optional environment variable 3 key for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment3Value:
    Description: 'Optional environment variable 3 value for sidecar container.'
    Type: String
    Default: ''
  Name:
    Description: 'The name of the service used for service discovery (Cloud Map).'
    Type: String
  Cpu:
    Description: 'The minimum number of vCPUs to reserve for the container.'
    Type: String
    Default: '0.25'
    AllowedValues: ['0.25', '0.5', '1', '2', '4']
  Memory:
    Description: 'The amount (in GB) of memory used by the task.'
    Type: String
    Default: '0.5'
    AllowedValues: ['0.5', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30']
  DesiredCount:
    Description: 'The number of simultaneous tasks, that you want to run on the cluster.'
    Type: Number
    Default: 2
    ConstraintDescription: 'Must be >= 1'
    MinValue: 1
  MaxCapacity:
    Description: 'The maximum number of simultaneous tasks, that you want to run on the cluster.'
    Type: Number
    Default: 4
    ConstraintDescription: 'Must be >= 1'
    MinValue: 1
  MinCapacity:
    Description: 'The minimum number of simultaneous tasks, that you want to run on the cluster.'
    Type: Number
    Default: 2
    ConstraintDescription: 'Must be >= 1'
    MinValue: 1
  LogsRetentionInDays:
    Description: 'Specifies the number of days you want to retain log events in the specified log group.'
    Type: Number
    Default: 14
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]
  SubnetsReach:
    Description: 'Should the service have direct access to the Internet or do you prefer private subnets with NAT?'
    Type: String
    Default: Public
    AllowedValues:
    - Public
    - Private
  AutoScaling:
    Description: 'Scale number of tasks based on CPU load?'
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
Conditions:
  HasSSHBastionSecurityGroup: !Not [!Equals [!Ref ParentSSHBastionStack, '']]
  HasProxyImage: !Not [!Equals [!Ref ProxyImage, '']]
Resources:
  ServiceDiscovery:
    Type: 'AWS::ServiceDiscovery::Service'
    Properties:
      Description: !Ref 'AWS::StackName'
      DnsConfig:
        DnsRecords:
        - Type: A
          TTL: 30
        - Type: SRV
          TTL: 30
        NamespaceId: {'Fn::ImportValue': !Sub '${ParentCloudMapStack}-NamespaceID'}
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: !Ref Name
      NamespaceId: {'Fn::ImportValue': !Sub '${ParentCloudMapStack}-NamespaceID'}
  ServiceSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: !Sub '${AWS::StackName}-service'
      VpcId: {'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC'}
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: !If [HasProxyImage, !Ref ProxyPort, !Ref AppPort]
        ToPort: !If [HasProxyImage, !Ref ProxyPort, !Ref AppPort]
        SourceSecurityGroupId: {'Fn::ImportValue': !Sub '${ParentClientStack}-ClientSecurityGroup'}
  ServiceSecurityGroupInSSHBastion:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Condition: HasSSHBastionSecurityGroup
    Properties:
      GroupId: !Ref ServiceSecurityGroup
      IpProtocol: tcp
      FromPort: !If [HasProxyImage, !Ref ProxyPort, !Ref AppPort]
      ToPort: !If [HasProxyImage, !Ref ProxyPort, !Ref AppPort]
      SourceSecurityGroupId: {'Fn::ImportValue': !Sub '${ParentSSHBastionStack}-SecurityGroup'}
  Service:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      Parameters:
        ServiceDiscoveryARN: !GetAtt 'ServiceDiscovery.Arn'
        ParentVPCStack: !Ref ParentVPCStack
        ServiceSecurityGroup: !Ref ServiceSecurityGroup
        ParentClusterStack: !Ref ParentClusterStack
        ParentAlertStack: !Ref ParentAlertStack
        ParentClientStack: !Ref ParentClientStack
        ParentClientStack1: !Ref ParentClientStack1
        ParentClientStack2: !Ref ParentClientStack2
        ParentClientStack3: !Ref ParentClientStack3
        TaskPolicies: !Ref TaskPolicies
        ProxyImage: !Ref ProxyImage
        ProxyCommand: !Ref ProxyCommand
        ProxyPort: !Ref ProxyPort
        ProxyEnvironment1Key: !Ref ProxyEnvironment1Key
        ProxyEnvironment1Value: !Ref ProxyEnvironment1Value
        ProxyEnvironment2Key: !Ref ProxyEnvironment2Key
        ProxyEnvironment2Value: !Ref ProxyEnvironment2Value
        ProxyEnvironment3Key: !Ref ProxyEnvironment3Key
        ProxyEnvironment3Value: !Ref ProxyEnvironment3Value
        AppImage: !Ref AppImage
        AppCommand: !Ref AppCommand
        AppPort: !Ref AppPort
        AppEnvironment1Key: !Ref AppEnvironment1Key
        AppEnvironment1Value: !Ref AppEnvironment1Value
        AppEnvironment2Key: !Ref AppEnvironment2Key
        AppEnvironment2Value: !Ref AppEnvironment2Value
        AppEnvironment3Key: !Ref AppEnvironment3Key
        AppEnvironment3Value: !Ref AppEnvironment3Value
        SidecarImage: !Ref SidecarImage
        SidecarCommand: !Ref SidecarCommand
        SidecarPort: !Ref SidecarPort
        SidecarEnvironment1Key: !Ref SidecarEnvironment1Key
        SidecarEnvironment1Value: !Ref SidecarEnvironment1Value
        SidecarEnvironment2Key: !Ref SidecarEnvironment2Key
        SidecarEnvironment2Value: !Ref SidecarEnvironment2Value
        SidecarEnvironment3Key: !Ref SidecarEnvironment3Key
        SidecarEnvironment3Value: !Ref SidecarEnvironment3Value
        Cpu: !Ref Cpu
        Memory: !Ref Memory
        SubnetsReach: !Ref SubnetsReach
        AutoScaling: !Ref AutoScaling
        DesiredCount: !Ref DesiredCount
        MaxCapacity: !Ref MaxCapacity
        MinCapacity: !Ref MinCapacity
        LogsRetentionInDays: !Ref LogsRetentionInDays
      TemplateURL: './service.yaml'
Outputs:
  TemplateID:
    Description: 'cloudonaut.io template id.'
    Value: 'fargate/service'
  TemplateVersion:
    Description: 'cloudonaut.io template version.'
    Value: '__VERSION__'
  StackName:
    Description: 'Stack name.'
    Value: !Sub '${AWS::StackName}'
